<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Licita√ß√µes com OCR</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>
<body style="font-family:sans-serif;padding:20px;background:#f4f4f4">

  <h2>üìã Sistema de Licita√ß√µes (com OCR)</h2>

  <input type="file" id="pdfInput" accept="application/pdf" />
  <hr />

  <form id="formulario">
    <label>N¬∫ da Licita√ß√£o:</label><br />
    <input type="text" id="numeroLicitacao" /><br /><br />

    <label>Data de Abertura:</label><br />
    <input type="date" id="dataAbertura" /><br /><br />

    <label>Nome do √ìrg√£o:</label><br />
    <input type="text" id="nomeOrgao" /><br /><br />

    <label>CNPJ:</label><br />
    <input type="text" id="cnpj" /><br /><br />

    <label>E-mail:</label><br />
    <input type="email" id="email" /><br /><br />

    <label>Telefone:</label><br />
    <input type="tel" id="telefone" /><br /><br />

    <label>Ramo:</label><br />
    <select id="ramo">
      <option value="">Selecione...</option>
      <option value="Empresarial">Empresarial</option>
      <option value="Frota">Frota</option>
      <option value="Vida">Vida</option>
      <option value="Garantia">Garantia</option>
      <option value="Transportes">Transportes</option>
      <option value="D&O">D&O</option>
      <option value="RC Ambiental">RC Ambiental</option>
    </select><br /><br />

    <label>Qtd. Itens:</label><br />
    <input type="text" id="quantidadeItens" /><br /><br />

    <button type="button" onclick="adicionarLicitacao()">‚ûï Adicionar</button>
  </form>

  <hr />
  <h3>üìë Licita√ß√µes</h3>
  <table border="1" width="100%" id="tabela">
    <thead>
      <tr>
        <th>N¬∫ Licita√ß√£o</th>
        <th>Data</th>
        <th>√ìrg√£o</th>
        <th>CNPJ</th>
        <th>Email</th>
        <th>Telefone</th>
        <th>Ramo</th>
        <th>Qtd. Itens</th>
        <th>Edital</th>
      </tr>
    </thead>
    <tbody id="corpoTabela"><tr><td colspan="9">Nenhuma licita√ß√£o ainda.</td></tr></tbody>
  </table>

  <canvas id="pdfCanvas" style="display:none;"></canvas>

  <script>
    const RAMOS = ['Empresarial', 'Frota', 'Vida', 'Garantia', 'Transportes', 'D&O', 'RC Ambiental'];
    let licitacoes = [];
    const pdfMap = new Map(); // guarda ObjectURLs tempor√°rios na sess√£o

    function formatarDataParaInput(dataPtBr) {
      const [d, m, a] = dataPtBr.split('/');
      return `${a}-${m}-${d}`;
    }

    function normalizarTexto(texto) {
      return texto.replace(/-\s*\n/g, '') // remove hifeniza√ß√£o de quebra de linha
                  .replace(/\s+/g, ' ')   // normaliza espa√ßos
                  .trim();
    }

    function detectarRamo(texto) {
      for (const ramo of RAMOS) {
        const regex = new RegExp(`\\b${ramo}\\b`, 'i');
        if (regex.test(texto)) return ramo;
      }
      return '';
    }

    function detectarQuantidade(texto) {
      if (/√∫nico item/i.test(texto)) return '1';
      const match = texto.match(/(\d{1,5})\s+(?:itens?|ve[√≠i]culos|segurados|riscos|ap[o√≥]lices)/i);
      return match ? match[1] : '';
    }

    function aplicarMascaraCNPJ(cnpj) {
      return cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, "$1.$2.$3/$4-$5");
    }

    function aplicarMascaraTelefone(tel) {
      return tel.replace(/^(\d{2})(\d{4,5})(\d{4})$/, "($1) $2-$3");
    }

    function extrairCamposDoTexto(texto) {
      const clean = normalizarTexto(texto);
      console.log("üîç Texto normalizado (pr√©via):", clean.slice(0, 500));

      const numeroLicitacao = clean.match(/\b\d{4,6}\/\d{4}\b/);
      const cnpj = clean.match(/\b\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}\b/);
      const email = clean.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-z]{2,}/);
      const telefone = clean.match(/\(\d{2}\)\s?\d{4,5}-\d{4}/);
      const data = clean.match(/\b\d{2}\/\d{2}\/\d{4}\b/);
      const orgao = clean.match(/(Funda√ß√£o|Prefeitura|Secretaria|Tribunal|Governo)[^\n]{0,100}/i);
      const ramo = detectarRamo(clean);
      const quantidade = detectarQuantidade(clean);

      if (numeroLicitacao) document.getElementById('numeroLicitacao').value = numeroLicitacao[0];
      if (cnpj) document.getElementById('cnpj').value = cnpj[0];
      if (email) document.getElementById('email').value = email[0];
      if (telefone) document.getElementById('telefone').value = telefone[0];
      if (data) document.getElementById('dataAbertura').value = formatarDataParaInput(data[0]);
      if (orgao) document.getElementById('nomeOrgao').value = orgao[0].trim();
      if (ramo) document.getElementById('ramo').value = ramo;
      if (quantidade) document.getElementById('quantidadeItens').value = quantidade;
    }

    async function processarComOCR(page) {
      const canvas = document.getElementById('pdfCanvas');
      const viewport = page.getViewport({ scale: 3.5 });
      const context = canvas.getContext('2d');

      canvas.width = viewport.width;
      canvas.height = viewport.height;
      await page.render({ canvasContext: context, viewport: viewport }).promise;

      document.body.style.cursor = "wait";
      const { data: { text } } = await Tesseract.recognize(canvas, 'por+eng');
      document.body.style.cursor = "default";

      extrairCamposDoTexto(text);
    }

    async function processarPDF(file) {
      const typedArray = new Uint8Array(await file.arrayBuffer());
      const pdf = await pdfjsLib.getDocument({ data: typedArray }).promise;
      let textoCompleto = "";

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const textoPagina = textContent.items.map(item => item.str).join(" ");
        textoCompleto += " " + textoPagina;
      }

      if (textoCompleto.trim().length < 20) {
        console.log("üì∏ Texto n√£o encontrado, usando OCR...");
        const page = await pdf.getPage(1);
        await processarComOCR(page);
      } else {
        extrairCamposDoTexto(textoCompleto);
      }
    }

    document.getElementById('pdfInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (file) processarPDF(file);
    });

    function adicionarLicitacao() {
      const fileInput = document.getElementById('pdfInput');
      const file = fileInput.files[0];

      if (!file) {
        alert("Selecione um edital antes de adicionar!");
        return;
      }

      const url = URL.createObjectURL(file);

      const nova = {
        numero: document.getElementById('numeroLicitacao').value,
        data: document.getElementById('dataAbertura').value,
        orgao: document.getElementById('nomeOrgao').value,
        cnpj: document.getElementById('cnpj').value.replace(/\D/g, '').length === 14 ? aplicarMascaraCNPJ(document.getElementById('cnpj').value.replace(/\D/g,'')) : document.getElementById('cnpj').value,
        email: document.getElementById('email').value,
        telefone: document.getElementById('telefone').value.replace(/\D/g, '').length >= 10 ? aplicarMascaraTelefone(document.getElementById('telefone').value.replace(/\D/g,'')) : document.getElementById('telefone').value,
        ramo: document.getElementById('ramo').value,
        itens: document.getElementById('quantidadeItens').value,
        editalId: Date.now() // id tempor√°rio para mapear URL
      };

      if (!nova.numero || !nova.data || !nova.orgao) {
        alert("Preencha os campos principais antes de salvar!");
        return;
      }

      licitacoes.push(nova);
      pdfMap.set(nova.editalId, url);

      try {
        salvarLocal();
      } catch (e) {
        console.warn("‚ö†Ô∏è Limite do localStorage atingido, n√£o foi poss√≠vel salvar permanentemente:", e);
      }

      atualizarTabela();
      document.getElementById('formulario').reset();
      document.getElementById('pdfInput').value = "";
    }

    function atualizarTabela() {
      const tbody = document.getElementById('corpoTabela');
      if (licitacoes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9">Nenhuma licita√ß√£o ainda.</td></tr>';
        return;
      }

      tbody.innerHTML = licitacoes.map(l => {
        const url = pdfMap.get(l.editalId);
        return `
        <tr>
          <td>${l.numero}</td>
          <td>${l.data}</td>
          <td>${l.orgao}</td>
          <td>${l.cnpj}</td>
          <td>${l.email}</td>
          <td>${l.telefone}</td>
          <td>${l.ramo}</td>
          <td>${l.itens}</td>
          <td>${url ? `<a href="${url}" target="_blank">üìÑ Abrir edital</a>` : '<span style="color:red">‚ö†Ô∏è PDF n√£o dispon√≠vel ap√≥s reload</span>'}</td>
        </tr>
      `;
      }).join('');
    }

    function salvarLocal() {
      localStorage.setItem('licitacoes', JSON.stringify(licitacoes));
    }

    function carregarLocal() {
      const dados = localStorage.getItem('licitacoes');
      if (dados) {
        licitacoes = JSON.parse(dados);
        atualizarTabela();
      }
    }

    carregarLocal();
  </script>
</body>
</html>
