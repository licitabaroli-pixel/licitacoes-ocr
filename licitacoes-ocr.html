<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>LicitaÃ§Ãµes com OCR</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
</head>
<body style="font-family:sans-serif;padding:20px;background:#f4f4f4">

  <h2>ðŸ“‹ Sistema de LicitaÃ§Ãµes (com OCR)</h2>

  <input type="file" id="pdfInput" accept="application/pdf" />
  <hr />

  <form id="formulario">
    <label>NÂº da LicitaÃ§Ã£o:</label><br />
    <input type="text" id="numeroLicitacao" /><br /><br />

    <label>Data de Abertura:</label><br />
    <input type="date" id="dataAbertura" /><br /><br />

    <label>Nome do Ã“rgÃ£o:</label><br />
    <input type="text" id="nomeOrgao" /><br /><br />

    <label>CNPJ:</label><br />
    <input type="text" id="cnpj" /><br /><br />

    <label>E-mail:</label><br />
    <input type="email" id="email" /><br /><br />

    <label>Telefone:</label><br />
    <input type="tel" id="telefone" /><br /><br />

    <label>Ramo:</label><br />
    <select id="ramo">
      <option value="">Selecione...</option>
      <option value="Empresarial">Empresarial</option>
      <option value="Frota">Frota</option>
      <option value="Vida">Vida</option>
      <option value="Garantia">Garantia</option>
      <option value="Transportes">Transportes</option>
      <option value="D&O">D&O</option>
      <option value="RC Ambiental">RC Ambiental</option>
    </select><br /><br />

    <label>Qtd. Itens:</label><br />
    <input type="text" id="quantidadeItens" /><br /><br />

    <button type="button" onclick="adicionarLicitacao()">âž• Adicionar</button>
  </form>

  <hr />
  <h3>ðŸ“‘ LicitaÃ§Ãµes</h3>
  <table border="1" width="100%" id="tabela">
    <thead>
      <tr>
        <th>NÂº LicitaÃ§Ã£o</th>
        <th>Data</th>
        <th>Ã“rgÃ£o</th>
        <th>CNPJ</th>
        <th>Email</th>
        <th>Telefone</th>
        <th>Ramo</th>
        <th>Qtd. Itens</th>
        <th>Edital</th>
      </tr>
    </thead>
    <tbody id="corpoTabela"><tr><td colspan="9">Nenhuma licitaÃ§Ã£o ainda.</td></tr></tbody>
  </table>

  <canvas id="pdfCanvas" style="display:none;"></canvas>

  <script>
    const RAMOS = ['Empresarial', 'Frota', 'Vida', 'Garantia', 'Transportes', 'D&O', 'RC Ambiental'];
    let licitacoes = [];

    function formatarDataParaInput(dataPtBr) {
      const [d, m, a] = dataPtBr.split('/');
      return `${a}-${m}-${d}`;
    }

    function detectarRamo(texto) {
      for (const ramo of RAMOS) {
        const regex = new RegExp(ramo, 'i');
        if (regex.test(texto)) return ramo;
      }
      return '';
    }

    function detectarQuantidade(texto, ramo) {
      if (ramo === 'Empresarial') {
        const enderecos = texto.match(/(Rua|Av\.?|Avenida|Travessa|Rodovia|Estrada)[^\n,]+,\s*n?[0-9]+/gi);
        return enderecos ? enderecos.length : 1;
      } else {
        const match = texto.match(/(\d{1,4})\s+(ve[Ã­i]culos|itens|segurados|riscos|ap[oÃ³]lices)/i);
        return match ? match[1] : '';
      }
    }

    function extrairCamposDoTexto(texto) {
      console.log("ðŸ” Texto extraÃ­do (prÃ©via):", texto.slice(0, 500));

      const numeroLicitacao = texto.match(/(Preg[aÃ£]o|Concorr[eÃª]ncia|Tomada de Pre[cÃ§]os|Convite)\s*(n[Âºo.]*)?\s*\d{1,4}\/\d{4}/i);
      const cnpj = texto.match(/\d{2}\.?\d{3}\.?\d{3}\/?\d{4}-?\d{2}/);
      const email = texto.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-z]{2,}/);
      const telefone = texto.match(/\(?\d{2}\)?[\s-]?\d{4,5}-?\d{4}/);
      const data = texto.match(/\d{2}\/\d{2}\/\d{4}/);
      const orgao = texto.match(/(Prefeitura|Secretaria|Tribunal|Governo)[^\n]{0,100}/i);
      const ramo = detectarRamo(texto);
      const quantidade = detectarQuantidade(texto, ramo);

      if (numeroLicitacao) document.getElementById('numeroLicitacao').value = numeroLicitacao[0];
      if (cnpj) document.getElementById('cnpj').value = cnpj[0];
      if (email) document.getElementById('email').value = email[0];
      if (telefone) document.getElementById('telefone').value = telefone[0];
      if (data) document.getElementById('dataAbertura').value = formatarDataParaInput(data[0]);
      if (orgao) document.getElementById('nomeOrgao').value = orgao[0].trim();
      if (ramo) document.getElementById('ramo').value = ramo;
      if (quantidade) document.getElementById('quantidadeItens').value = quantidade;
    }

    async function processarComOCR(page) {
      const canvas = document.getElementById('pdfCanvas');
      const viewport = page.getViewport({ scale: 3.5 });
      const context = canvas.getContext('2d');

      canvas.width = viewport.width;
      canvas.height = viewport.height;
      await page.render({ canvasContext: context, viewport: viewport }).promise;

      const { data: { text } } = await Tesseract.recognize(canvas, 'por+eng', {
        logger: m => console.log(m)
      });

      extrairCamposDoTexto(text);
    }

    async function processarPDF(file) {
      const typedArray = new Uint8Array(await file.arrayBuffer());
      const pdf = await pdfjsLib.getDocument({ data: typedArray }).promise;
      let textoCompleto = "";

      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const textoPagina = textContent.items.map(item => item.str).join(" ");
        textoCompleto += " " + textoPagina;
      }

      if (textoCompleto.trim().length < 20) {
        console.log("ðŸ“¸ Texto nÃ£o encontrado, usando OCR...");
        const page = await pdf.getPage(1);
        await processarComOCR(page);
      } else {
        extrairCamposDoTexto(textoCompleto);
      }
    }

    document.getElementById('pdfInput').addEventListener('change', function (e) {
      const file = e.target.files[0];
      if (file) processarPDF(file);
    });

    function adicionarLicitacao() {
      const fileInput = document.getElementById('pdfInput');
      const file = fileInput.files[0];

      if (!file) {
        alert("Selecione um edital antes de adicionar!");
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const base64PDF = e.target.result;

        const nova = {
          numero: document.getElementById('numeroLicitacao').value,
          data: document.getElementById('dataAbertura').value,
          orgao: document.getElementById('nomeOrgao').value,
          cnpj: document.getElementById('cnpj').value,
          email: document.getElementById('email').value,
          telefone: document.getElementById('telefone').value,
          ramo: document.getElementById('ramo').value,
          itens: document.getElementById('quantidadeItens').value,
          edital: base64PDF
        };

        licitacoes.push(nova);
        salvarLocal();
        atualizarTabela();
        document.getElementById('formulario').reset();
      };

      reader.readAsDataURL(file);
    }

    function atualizarTabela() {
      const tbody = document.getElementById('corpoTabela');
      if (licitacoes.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9">Nenhuma licitaÃ§Ã£o ainda.</td></tr>';
        return;
      }

      tbody.innerHTML = licitacoes.map(l => `
        <tr>
          <td>${l.numero}</td>
          <td>${l.data}</td>
          <td>${l.orgao}</td>
          <td>${l.cnpj}</td>
          <td>${l.email}</td>
          <td>${l.telefone}</td>
          <td>${l.ramo}</td>
          <td>${l.itens}</td>
          <td><a href="${l.edital}" target="_blank">ðŸ“„ Abrir edital</a></td>
        </tr>
      `).join('');
    }

    function salvarLocal() {
      localStorage.setItem('licitacoes', JSON.stringify(licitacoes));
    }

    function carregarLocal() {
      const dados = localStorage.getItem('licitacoes');
      if (dados) {
        licitacoes = JSON.parse(dados);
        atualizarTabela();
      }
    }

    carregarLocal();
  </script>
</body>
</html>
